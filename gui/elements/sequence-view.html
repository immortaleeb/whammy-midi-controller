<link rel="import"
      href="../../bower_components/polymer/polymer.html">
<link rel="import" href="sequence-step.html">

<dom-module id="sequence-view">
  <template>
    Step: {{activeStep}}
    <template is="dom-repeat" items="{{sequence}}" as="step" index="index">
      <sequence-step id$="step-{{index}}" step="{{step}}" deleteable="{{canDelete}}" on-delete-step="_deleteStep"></sequence-step>
    </template>
    <button id="add-step-button">Add step</button>
  </template>

  <script>
    'use strict';

    (function() {
      Polymer({
        is: 'sequence-view',

        properties: {
          sequence: {
            type: Array,
            notify: true,
            observer: 'sequenceChanged'
          },
          activeStep: {
            observer: 'activeStepChanged'
          },
          canDelete: {
            type: Array,
            notify: true
          }
        },

        ready() {
          this.$['add-step-button'].addEventListener('click', () => {
            // FIXME clean this up: for some reason sequenceChanged doesn't get called when using polymer methods
            let clone = this.sequence.slice(0);
            clone.push({ mode: 0 });
            this.set('sequence', clone);
          });
        },

        sequenceChanged() {
          this.canDelete = (this.sequence.length > 1);
        },

        activeStepChanged(newActiveStep, oldActiveStep) {
          let oldStep = this.$$(`#step-${oldActiveStep}`);
          let newStep = this.$$(`#step-${newActiveStep}`);
          oldStep && (oldStep.active = false);
          newStep && (newStep.active = true);
        },

        _deleteStep(event) {
          // FIXME clean this up: for some reason sequenceChanged doesn't get called when using polymer methods
          let clone = this.sequence.slice(0);
          let index = this.sequence.indexOf(event.detail.step);
          clone.splice(index, 1);
          this.set('sequence', clone);
        }
      });
    }());
  </script>
</dom-module>
